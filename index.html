import React, { useState, useEffect } from 'react';
import { Plus, X, TrendingUp, List, Calendar, Settings, HelpCircle } from 'lucide-react';

const DEFAULT_MILESTONES = [
  { name: 'Super Stack', points: 50, color: 'emerald', id: 1 },
  { name: 'Mega Stack', points: 100, color: 'blue', id: 2 },
  { name: 'Ultra Stack', points: 150, color: 'purple', id: 3 },
  { name: 'Hyper Stack', points: 200, color: 'amber', id: 4 }
];

const DEFAULT_STACK_BUTTONS = [
  { name: 'Stack', points: 1, id: 1 },
  { name: 'Stack X5', points: 5, id: 2 },
  { name: 'Stack X10', points: 10, id: 3 }
];

const COLOR_OPTIONS = [
  { name: 'Emerald', value: 'emerald' },
  { name: 'Blue', value: 'blue' },
  { name: 'Purple', value: 'purple' },
  { name: 'Amber', value: 'amber' },
  { name: 'Red', value: 'red' },
  { name: 'Pink', value: 'pink' },
  { name: 'Indigo', value: 'indigo' },
  { name: 'Teal', value: 'teal' },
  { name: 'Orange', value: 'orange' },
  { name: 'Cyan', value: 'cyan' },
  { name: 'Lime', value: 'lime' },
  { name: 'Rose', value: 'rose' }
];

const COLOR_SCHEMES = {
  default: {
    bg: 'bg-slate-900',
    card: 'bg-slate-800',
    button: 'bg-slate-700 hover:bg-slate-600',
    text: 'text-white',
    accent: 'text-slate-400',
    input: 'bg-slate-700 text-white'
  },
  emerald: {
    bg: 'bg-emerald-900',
    card: 'bg-emerald-800',
    button: 'bg-emerald-700 hover:bg-emerald-600',
    text: 'text-white',
    accent: 'text-emerald-300',
    input: 'bg-emerald-700 text-white'
  },
  blue: {
    bg: 'bg-blue-900',
    card: 'bg-blue-800',
    button: 'bg-blue-700 hover:bg-blue-600',
    text: 'text-white',
    accent: 'text-blue-300',
    input: 'bg-blue-700 text-white'
  },
  purple: {
    bg: 'bg-purple-900',
    card: 'bg-purple-800',
    button: 'bg-purple-700 hover:bg-purple-600',
    text: 'text-white',
    accent: 'text-purple-300',
    input: 'bg-purple-700 text-white'
  },
  amber: {
    bg: 'bg-amber-600',
    card: 'bg-amber-500',
    button: 'bg-amber-400 hover:bg-amber-300',
    text: 'text-slate-900',
    accent: 'text-amber-900',
    input: 'bg-amber-300 text-slate-900'
  },
  red: {
    bg: 'bg-red-900',
    card: 'bg-red-800',
    button: 'bg-red-700 hover:bg-red-600',
    text: 'text-white',
    accent: 'text-red-300',
    input: 'bg-red-700 text-white'
  },
  pink: {
    bg: 'bg-pink-900',
    card: 'bg-pink-800',
    button: 'bg-pink-700 hover:bg-pink-600',
    text: 'text-white',
    accent: 'text-pink-300',
    input: 'bg-pink-700 text-white'
  },
  indigo: {
    bg: 'bg-indigo-900',
    card: 'bg-indigo-800',
    button: 'bg-indigo-700 hover:bg-indigo-600',
    text: 'text-white',
    accent: 'text-indigo-300',
    input: 'bg-indigo-700 text-white'
  },
  teal: {
    bg: 'bg-teal-900',
    card: 'bg-teal-800',
    button: 'bg-teal-700 hover:bg-teal-600',
    text: 'text-white',
    accent: 'text-teal-300',
    input: 'bg-teal-700 text-white'
  },
  orange: {
    bg: 'bg-orange-600',
    card: 'bg-orange-500',
    button: 'bg-orange-400 hover:bg-orange-300',
    text: 'text-slate-900',
    accent: 'text-orange-900',
    input: 'bg-orange-300 text-slate-900'
  },
  cyan: {
    bg: 'bg-cyan-900',
    card: 'bg-cyan-800',
    button: 'bg-cyan-700 hover:bg-cyan-600',
    text: 'text-white',
    accent: 'text-cyan-300',
    input: 'bg-cyan-700 text-white'
  },
  lime: {
    bg: 'bg-lime-600',
    card: 'bg-lime-500',
    button: 'bg-lime-400 hover:bg-lime-300',
    text: 'text-slate-900',
    accent: 'text-lime-900',
    input: 'bg-lime-300 text-slate-900'
  },
  rose: {
    bg: 'bg-rose-900',
    card: 'bg-rose-800',
    button: 'bg-rose-700 hover:bg-rose-600',
    text: 'text-white',
    accent: 'text-rose-300',
    input: 'bg-rose-700 text-white'
  }
};

export default function HyperStacksApp() {
  const [currentStacks, setCurrentStacks] = useState(0);
  const [tasks, setTasks] = useState([]);
  const [history, setHistory] = useState([]);
  const [activeTab, setActiveTab] = useState('tracker');
  const [showAddTask, setShowAddTask] = useState(false);
  const [newTask, setNewTask] = useState({ name: '', points: 1 });
  const [currentDate, setCurrentDate] = useState(new Date().toDateString());
  const [milestones, setMilestones] = useState(DEFAULT_MILESTONES);
  const [stackButtons, setStackButtons] = useState(DEFAULT_STACK_BUTTONS);
  const [showHelp, setShowHelp] = useState(false);
  const [showAddMilestone, setShowAddMilestone] = useState(false);
  const [newMilestone, setNewMilestone] = useState({ name: '', points: 0, color: 'emerald' });

  useEffect(() => {
    const savedData = window.hyperStacksData || {
      currentStacks: 0,
      tasks: [],
      history: [],
      lastDate: new Date().toDateString(),
      milestones: DEFAULT_MILESTONES,
      stackButtons: DEFAULT_STACK_BUTTONS
    };

    const today = new Date().toDateString();
    if (savedData.lastDate !== today && savedData.currentStacks > 0) {
      const reachedMilestones = savedData.milestones.filter(m => savedData.currentStacks >= m.points).length;
      const newHistory = [...savedData.history, {
        date: savedData.lastDate,
        stacks: savedData.currentStacks,
        milestones: reachedMilestones
      }];
      
      setHistory(newHistory);
      setCurrentStacks(0);
      setTasks(savedData.tasks);
      setMilestones(savedData.milestones);
      setStackButtons(savedData.stackButtons);
      window.hyperStacksData = {
        currentStacks: 0,
        tasks: savedData.tasks,
        history: newHistory,
        lastDate: today,
        milestones: savedData.milestones,
        stackButtons: savedData.stackButtons
      };
    } else {
      setCurrentStacks(savedData.currentStacks);
      setTasks(savedData.tasks);
      setHistory(savedData.history);
      setMilestones(savedData.milestones);
      setStackButtons(savedData.stackButtons);
    }
    
    setCurrentDate(today);
  }, []);

  useEffect(() => {
    window.hyperStacksData = {
      currentStacks,
      tasks,
      history,
      lastDate: currentDate,
      milestones,
      stackButtons
    };
  }, [currentStacks, tasks, history, currentDate, milestones, stackButtons]);

  const addStacks = (amount) => {
    const maxPoints = milestones.length > 0 ? Math.max(...milestones.map(m => m.points)) : 200;
    setCurrentStacks(prev => Math.min(prev + amount, maxPoints));
  };

  const addTask = () => {
    if (newTask.name.trim()) {
      setTasks([...tasks, { ...newTask, id: Date.now() }]);
      setNewTask({ name: '', points: 1 });
      setShowAddTask(false);
    }
  };

  const deleteTask = (id) => {
    setTasks(tasks.filter(t => t.id !== id));
  };

  const updateStackButton = (id, field, value) => {
    setStackButtons(stackButtons.map(btn => 
      btn.id === id ? { ...btn, [field]: field === 'points' ? parseInt(value) || 0 : value } : btn
    ));
  };

  const updateMilestone = (id, field, value) => {
    setMilestones(milestones.map(m => 
      m.id === id ? { ...m, [field]: field === 'points' ? parseInt(value) || 0 : value } : m
    ));
  };

  const deleteMilestone = (id) => {
    setMilestones(milestones.filter(m => m.id !== id));
  };

  const addMilestone = () => {
    if (newMilestone.name.trim() && newMilestone.points > 0) {
      setMilestones([...milestones, { ...newMilestone, id: Date.now() }].sort((a, b) => a.points - b.points));
      setNewMilestone({ name: '', points: 0, color: 'emerald' });
      setShowAddMilestone(false);
    }
  };

  const getCurrentMilestone = () => {
    const sortedMilestones = [...milestones].sort((a, b) => b.points - a.points);
    for (let milestone of sortedMilestones) {
      if (currentStacks >= milestone.points) {
        return milestone;
      }
    }
    return null;
  };

  const getNextMilestone = () => {
    const sortedMilestones = [...milestones].sort((a, b) => a.points - b.points);
    return sortedMilestones.find(m => currentStacks < m.points);
  };

  const currentMilestone = getCurrentMilestone();
  const nextMilestone = getNextMilestone();
  const colorScheme = COLOR_SCHEMES[currentMilestone?.color || 'default'];
  const maxHistory = Math.max(...history.map(h => h.stacks), milestones.length > 0 ? Math.max(...milestones.map(m => m.points)) : 200);

  return (
    <div className={`min-h-screen ${colorScheme.bg} ${colorScheme.text} pb-20`}>
      {/* Help Button */}
      <button
        onClick={() => setShowHelp(true)}
        className={`fixed bottom-6 right-6 ${colorScheme.button} p-4 rounded-full shadow-2xl z-50`}
      >
        <HelpCircle size={28} />
      </button>

      {/* Help Modal */}
      {showHelp && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
          <div className={`${colorScheme.card} rounded-2xl p-6 max-w-lg w-full max-h-[80vh] overflow-y-auto`}>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold">How Hyper Stacks Works</h2>
              <button onClick={() => setShowHelp(false)} className={`${colorScheme.button} p-2 rounded-full`}>
                <X size={24} />
              </button>
            </div>
            <div className="space-y-4 text-sm">
              <div>
                <h3 className="font-semibold mb-2">📊 Tracker Tab</h3>
                <p>Tap the Stack buttons to earn points throughout your day. Watch the color scheme change as you reach different milestones! Your progress resets at midnight each day.</p>
              </div>
              <div>
                <h3 className="font-semibold mb-2">✅ Tasks Tab</h3>
                <p>Create a list of your daily tasks and assign point values (1, 5, or 10 points) to each. Use this as a reference guide to know how much each completed task is worth.</p>
              </div>
              <div>
                <h3 className="font-semibold mb-2">📅 History Tab</h3>
                <p>View your past performance with a graph and detailed records showing how many stacks you earned and milestones you reached each day.</p>
              </div>
              <div>
                <h3 className="font-semibold mb-2">⚙️ Settings Tab</h3>
                <p>Customize your experience! Change stack button names and point values, edit milestone names and requirements, add new milestones with custom colors, or remove milestones you don't need.</p>
              </div>
              <div>
                <h3 className="font-semibold mb-2">🎨 Color Schemes</h3>
                <p>The app's color scheme automatically changes when you reach each milestone, providing visual feedback on your progress throughout the day.</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Header */}
      <div className={`${colorScheme.card} p-6 shadow-lg`}>
        <h1 className="text-3xl font-bold text-center mb-2">Hyper Stacks</h1>
        <p className={`text-center ${colorScheme.accent} text-sm`}>
          {new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
        </p>
      </div>

      {/* Tab Navigation */}
      <div className="flex border-b border-slate-700">
        <button
          onClick={() => setActiveTab('tracker')}
          className={`flex-1 py-3 px-4 flex items-center justify-center gap-2 ${
            activeTab === 'tracker' ? colorScheme.button : 'bg-transparent'
          }`}
        >
          <TrendingUp size={20} />
          Tracker
        </button>
        <button
          onClick={() => setActiveTab('tasks')}
          className={`flex-1 py-3 px-4 flex items-center justify-center gap-2 ${
            activeTab === 'tasks' ? colorScheme.button : 'bg-transparent'
          }`}
        >
          <List size={20} />
          Tasks
        </button>
        <button
          onClick={() => setActiveTab('history')}
          className={`flex-1 py-3 px-4 flex items-center justify-center gap-2 ${
            activeTab === 'history' ? colorScheme.button : 'bg-transparent'
          }`}
        >
          <Calendar size={20} />
          History
        </button>
        <button
          onClick={() => setActiveTab('settings')}
          className={`flex-1 py-3 px-4 flex items-center justify-center gap-2 ${
            activeTab === 'settings' ? colorScheme.button : 'bg-transparent'
          }`}
        >
          <Settings size={20} />
          Settings
        </button>
      </div>

      {/* Main Content */}
      <div className="p-6">
        {activeTab === 'tracker' && (
          <div className="space-y-6">
            {/* Current Stack Count */}
            <div className={`${colorScheme.card} rounded-2xl p-8 text-center shadow-xl`}>
              <p className={`${colorScheme.accent} text-sm uppercase tracking-wide mb-2`}>
                Current Stacks
              </p>
              <p className="text-6xl font-bold mb-4">{currentStacks}</p>
              {currentMilestone && (
                <div className="mb-2">
                  <span className={`inline-block px-4 py-2 rounded-full ${colorScheme.button} font-semibold`}>
                    🏆 {currentMilestone.name}
                  </span>
                </div>
              )}
              {nextMilestone && (
                <p className={`${colorScheme.accent} text-sm`}>
                  {nextMilestone.points - currentStacks} more to {nextMilestone.name}
                </p>
              )}
              {!nextMilestone && currentStacks > 0 && (
                <p className={`${colorScheme.accent} text-sm`}>
                  🎉 Maximum milestone reached!
                </p>
              )}
            </div>

            {/* Milestone Progress */}
            {milestones.length > 0 && (
              <div className={`${colorScheme.card} rounded-2xl p-6 shadow-xl`}>
                <h3 className="font-semibold mb-4">Milestone Progress</h3>
                <div className="space-y-3">
                  {[...milestones].sort((a, b) => a.points - b.points).map((milestone, idx) => {
                    const isReached = currentStacks >= milestone.points;
                    const progress = Math.min((currentStacks / milestone.points) * 100, 100);
                    
                    return (
                      <div key={milestone.id}>
                        <div className="flex justify-between text-sm mb-1">
                          <span>{milestone.name}</span>
                          <span>{milestone.points} pts</span>
                        </div>
                        <div className="w-full bg-slate-700 rounded-full h-2">
                          <div
                            className={`h-2 rounded-full transition-all duration-500 ${
                              isReached ? `bg-${milestone.color}-500` : 'bg-slate-600'
                            }`}
                            style={{ width: `${progress}%` }}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Stack Buttons */}
            <div className="space-y-3">
              {stackButtons.map(btn => (
                <button
                  key={btn.id}
                  onClick={() => addStacks(btn.points)}
                  className={`w-full ${colorScheme.button} py-6 rounded-xl font-bold text-xl shadow-lg transition-transform active:scale-95`}
                >
                  {btn.name} (+{btn.points})
                </button>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'tasks' && (
          <div className="space-y-4">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold">Task List</h2>
              <button
                onClick={() => setShowAddTask(true)}
                className={`${colorScheme.button} p-3 rounded-full shadow-lg`}
              >
                <Plus size={24} />
              </button>
            </div>

            {showAddTask && (
              <div className={`${colorScheme.card} rounded-xl p-4 shadow-xl mb-4`}>
                <input
                  type="text"
                  placeholder="Task name..."
                  value={newTask.name}
                  onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
                  className={`w-full ${colorScheme.input} rounded-lg px-4 py-3 mb-3 outline-none`}
                />
                <div className="flex gap-2 mb-3">
                  {[1, 5, 10].map(points => (
                    <button
                      key={points}
                      onClick={() => setNewTask({ ...newTask, points })}
                      className={`flex-1 py-2 rounded-lg ${
                        newTask.points === points ? colorScheme.button : colorScheme.input
                      }`}
                    >
                      {points} pt{points > 1 ? 's' : ''}
                    </button>
                  ))}
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={addTask}
                    className={`flex-1 ${colorScheme.button} py-2 rounded-lg font-semibold`}
                  >
                    Add Task
                  </button>
                  <button
                    onClick={() => setShowAddTask(false)}
                    className={`px-4 py-2 ${colorScheme.input} rounded-lg`}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}

            <div className="space-y-2">
              {tasks.length === 0 ? (
                <p className={`text-center ${colorScheme.accent} py-8`}>
                  No tasks yet. Add your first task!
                </p>
              ) : (
                tasks.map(task => (
                  <div
                    key={task.id}
                    className={`${colorScheme.card} rounded-xl p-4 flex justify-between items-center shadow-lg`}
                  >
                    <div>
                      <p className="font-semibold">{task.name}</p>
                      <p className={`text-sm ${colorScheme.accent}`}>{task.points} point{task.points > 1 ? 's' : ''}</p>
                    </div>
                    <button
                      onClick={() => deleteTask(task.id)}
                      className="p-2 bg-red-600 hover:bg-red-700 rounded-full"
                    >
                      <X size={20} />
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="space-y-4">
            <h2 className="text-2xl font-bold mb-4">History</h2>
            
            {history.length === 0 ? (
              <p className={`text-center ${colorScheme.accent} py-8`}>
                No history yet. Complete your first day!
              </p>
            ) : (
              <>
                <div className={`${colorScheme.card} rounded-xl p-6 shadow-xl mb-6`}>
                  <h3 className="font-semibold mb-4">Stack History</h3>
                  <div className="flex items-end justify-between h-48 gap-2">
                    {history.slice(-7).map((day, idx) => {
                      const height = (day.stacks / maxHistory) * 100;
                      return (
                        <div key={idx} className="flex-1 flex flex-col items-center gap-2">
                          <div className="w-full flex flex-col justify-end h-full">
                            <div
                              className={`w-full ${colorScheme.button} rounded-t transition-all`}
                              style={{ height: `${height}%` }}
                            />
                          </div>
                          <p className="text-xs text-center">{day.stacks}</p>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div className="space-y-2">
                  {history.slice().reverse().map((day, idx) => (
                    <div
                      key={idx}
                      className={`${colorScheme.card} rounded-xl p-4 shadow-lg`}
                    >
                      <div className="flex justify-between items-center">
                        <div>
                          <p className="font-semibold">{day.date}</p>
                          <p className={`text-sm ${colorScheme.accent}`}>
                            {day.stacks} stacks • {day.milestones} milestone{day.milestones !== 1 ? 's' : ''}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="text-2xl font-bold">{day.stacks}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        )}

        {activeTab === 'settings' && (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold mb-4">Settings</h2>

            {/* Stack Buttons Settings */}
            <div className={`${colorScheme.card} rounded-xl p-6 shadow-xl`}>
              <h3 className="font-semibold mb-4">Stack Buttons</h3>
              <div className="space-y-4">
                {stackButtons.map(btn => (
                  <div key={btn.id} className="space-y-2">
                    <label className="text-sm font-medium">Button {btn.id} Name</label>
                    <input
                      type="text"
                      value={btn.name}
                      onChange={(e) => updateStackButton(btn.id, 'name', e.target.value)}
                      className={`w-full ${colorScheme.input} rounded-lg px-4 py-2 outline-none`}
                    />
                    <label className="text-sm font-medium">Point Value</label>
                    <input
                      type="number"
                      value={btn.points}
                      onChange={(e) => updateStackButton(btn.id, 'points', e.target.value)}
                      className={`w-full ${colorScheme.input} rounded-lg px-4 py-2 outline-none`}
                      min="1"
                    />
                  </div>
                ))}
              </div>
            </div>

            {/* Milestones Settings */}
            <div className={`${colorScheme.card} rounded-xl p-6 shadow-xl`}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-semibold">Milestones</h3>
                <button
                  onClick={() => setShowAddMilestone(true)}
                  className={`${colorScheme.button} p-2 rounded-full`}
                >
                  <Plus size={20} />
                </button>
              </div>

              {showAddMilestone && (
                <div className="mb-4 p-4 border-2 border-dashed border-slate-600 rounded-lg space-y-3">
                  <input
                    type="text"
                    placeholder="Milestone name..."
                    value={newMilestone.name}
                    onChange={(e) => setNewMilestone({ ...newMilestone, name: e.target.value })}
                    className={`w-full ${colorScheme.input} rounded-lg px-4 py-2 outline-none`}
                  />
                  <input
                    type="number"
                    placeholder="Points required..."
                    value={newMilestone.points || ''}
                    onChange={(e) => setNewMilestone({ ...newMilestone, points: parseInt(e.target.value) || 0 })}
                    className={`w-full ${colorScheme.input} rounded-lg px-4 py-2 outline-none`}
                    min="1"
                  />
                  <select
                    value={newMilestone.color}
                    onChange={(e) => setNewMilestone({ ...newMilestone, color: e.target.value })}
                    className={`w-full ${colorScheme.input} rounded-lg px-4 py-2 outline-none`}
                  >
                    {COLOR_OPTIONS.map(color => (
                      <option key={color.value} value={color.value}>{color.name}</option>
                    ))}
                  </select>
                  <div className="flex gap-2">
                    <button
                      onClick={addMilestone}
                      className={`flex-1 ${colorScheme.button} py-2 rounded-lg font-semibold`}
                    >
                      Add Milestone
                    </button>
                    <button
                      onClick={() => setShowAddMilestone(false)}
                      className={`px-4 py-2 ${colorScheme.input} rounded-lg`}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}

              <div className="space-y-4">
                {[...milestones].sort((a, b) => a.points - b.points).map(milestone => (
                  <div key={milestone.id} className={`p-4 ${colorScheme.input} rounded-lg space-y-2`}>
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-semibold">Milestone</span>
                      <button
                        onClick={() => deleteMilestone(milestone.id)}
                        className="p-1 bg-red-600 hover:bg-red-700 rounded"
                      >
                        <X size={16} />
                      </button>
                    </div>
                    <input
                      type="text"
                      value={milestone.name}
                      onChange={(e) => updateMilestone(milestone.id, 'name', e.target.value)}
                      className={`w-full ${colorScheme.input} rounded px-3 py-2 outline-none border border-slate-600`}
                      placeholder="Milestone name"
                    />
                    <input
                      type="number"
                      value={milestone.points}
                      onChange={(e) => updateMilestone(milestone.id, 'points', e.target.value)}
                      className={`w-full ${colorScheme.input} rounded px-3 py-2 outline-none border border-slate-600`}
                      placeholder="Points required"
                      min="1"
                    />
                    <select
                      value={milestone.color}
                      onChange={(e) => updateMilestone(milestone.id, 'color', e.target.value)}
                      className={`w-full ${colorScheme.input} rounded px-3 py-2 outline-none border border-slate-600`}
                    >
                      {COLOR_OPTIONS.map(color => (
                        <option key={color.value} value={color.value}>{color.name}</option>
                      ))}
                    </select>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
